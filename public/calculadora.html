<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador Preliminar ‚Ä¢ RDH</title>
    <link rel="stylesheet" href="styles.css"> 
</head>
<body class="bg-dark">
    <header class="hdr">
        <div class="wrap hdr__row">
            <div class="hdr__brand">
            <a href="/" class="logo-link">
                <img src="img/logo_rhodes.png" class="logo" alt="RDH">
            </a>
            </div>
            <nav class="hdr__nav">
                <a href="index.html#catalogo">Proyectos</a>
                <a href="index.html#nosotros">Nosotros</a>
                <a href="calculadora.html" class="btn btn--primary">Cotizador</a>
            </nav>
            <a class="hdr__phone" href="https://wa.me/51922447700" target="_blank" rel="noopener">WhatsApp: 922447700</a>
        </div>
    </header>
    <section id="cotizador" class="section">
        <div class="wrap grid-2">
         <div>
                <h1 class="section__title" style="text-align: left;">Paso 1: Estima tu Inversi√≥n</h1>
                <p class="section__lead" style="text-align: left; margin-bottom: 30px;">
                    TENGA EN CUENTA QUE ESTA ES SOLO UNA ESTIMACI√ìN, LOS COSTOS PUEDEN VARIAR ENTRE UN 30% Y 40%.
                </p>
                <form id="cotizacionForm" class="form">
                    <h3>1. Dimensiones y Factores de Costo</h3>
                    <label for="metrado">Metrado Estimado (m¬≤ de Construcci√≥n, Longitud en km, o Cantidad de Partida):</label>
                    <input id="metrado" name="metrado" type="number" placeholder="Ej: 200 m¬≤ de construcci√≥n" value="100" required>
                    <small>Ejemplo: Si tu casa tiene 10 metros de largo y 10 metros de ancho, ingresa 100 m¬≤.</small>
                    
                    <label for="tipoObra">Tipo de Servicio Principal:</label>
                    <select id="tipoObra" name="tipoObra">
                        <option value="civil">Obra Civil y Cimentaci√≥n (Base)</option>
                        <option value="montaje">Montaje y Estructuras Met√°licas (Especializado: M√°s Costoso)</option>
                        <option value="electrica">Instalaci√≥n El√©ctrica / Telecomunicaciones (Muy Especializado: M√°s Costoso)</option>
                        <option value="logistica">Servicio de Log√≠stica y Transporte (Menos Costoso)</option>
                    </select>                   

                    <label for="acabado">Nivel de Acabado:</label>
                    <select id="acabado" name="acabado">
                        <option value="1.0">B√°sico (Funcional, Est√°ndar)</option>
                        <option value="1.5">Intermedio (Calidad Media, Buenos Materiales)</option>
                        <option value="2.5">Alto (Premium, Dise√±os Especiales y Costosos)</option>
                    </select>
                    
                    <label for="complejidadDiseno">Complejidad de Dise√±o/Ingenier√≠a:</label>
                    <select id="complejidadDiseno" name="complejidadDiseno">
                        <option value="1.0">Est√°ndar (Planos Simples)</option>
                        <option value="1.15">Moderada (Varias Especialidades)</option>
                        <option value="1.3">Alta (Dise√±o Personalizado o Industrial)</option>
                    </select>
                    
                    <label for="duracion">Prioridad / Tiempo Deseado:</label>
                    <select id="duracion" name="duracion">
                        <option value="1.0">Normal (Plazo sugerido por RDH)</option>
                        <option value="1.2">R√°pido (Exige m√°s horas/mano de obra, reduce Rendimiento)</option>
                        <option value="1.5">Urgente (Doble turno/Acelerado, Rendimiento muy bajo)</option>
                    </select>
                    
                    <label for="necesitaEquipos">Necesidad de Equipos Pesados:</label>
                    <select id="necesitaEquipos" name="necesitaEquipos">
                        <option value="1.0">No / Uso M√≠nimo (Equipos Ligeros)</option>
                        <option value="1.5">S√≠, Uso Moderado (Ajusta el CU Equipo)</option>
                        <option value="2.5">S√≠, Uso Intensivo (Ajusta mucho el CU Equipo)</option>
                    </select>                   

                    <label for="ubicacion">Ubicaci√≥n (Afecta la Log√≠stica y Costos de Transporte):</label>
                    <select id="ubicacion" name="ubicacion">
                        <option value="1.0">Lima Metropolitana y Callao</option>
                        <option value="1.15">Capital de Provincia (Interior del Pa√≠s)</option>
                        <option value="1.3">Zona Rural o de Dif√≠cil Acceso (Alto Costo de Log√≠stica)</option>
                    </select>

                    <label for="variacion">¬øQuieres incluir una variaci√≥n de precio?</label>
                    <input id="variacion" name="variacion" type="range" min="0" max="40" value="30">
                    <small>Rango de variaci√≥n de precio: 30%-40% para imprevistos.</small>
                    
                    <hr style="border-color: #f59e0b50; margin: 20px 0;">
                    <h3>2. Env√≠a tu Solicitud y Agenda la Cita</h3>
                    <input name="nombre" placeholder="Tu Nombre Completo" required>
                    <input name="correo" type="email" placeholder="Correo Electr√≥nico" required>
                    <input name="telefono" type="tel" placeholder="Tel√©fono/WhatsApp" required>
                    <textarea name="descripcion" rows="3" placeholder="Breve descripci√≥n del proyecto y horario de contacto preferido." required></textarea>
                    <button class="btn btn--primary" type="submit">
                        Calcular Estimaci√≥n y Enviar Solicitud
                    </button>
                    <p class="msg ok" id="msgForm"></p>
                </form>
           </div>
            
            <aside>
                <div class="card card--flat">
                    <h3 style="margin-top: 0;">An√°lisis Detallado en Costo basado en m2</h3>
                    <p>CU Material Ajustado: <span id="cuMaterialSpan">S/ 0.00</span></p>
                    <p>Costo CU Mano Obra: <span id="cuManoObraSpan">S/ 0.00</span></p>
                    <p>Rendimiento Mano Obra Ajustado: <span id="rendimientoAjustadoSpan">0.00 unid/d√≠a</span></p>
                    <p>Costo de Ingenier√≠a/Dise√±o: <span id="costoDisenoSpan">S/ 0.00</span></p>
                    <hr style="border-color: #334155; margin: 10px 0;">
                    <h3 style="margin-top: 0;">Presupuesto Preliminar</h3>
                    <p>Costo Directo Total (CD): <span id="costoDirectoSpan">S/ 0.00</span></p>
                    <p>Gastos Generales (8% GG): <span id="ggSpan">S/ 0.00</span></p>
                    <p>Utilidad (10%): <span id="utilidadSpan">S/ 0.00</span></p>
                    <hr>
                    <h3 style="color: var(--accent);">Costo Estimado Aproximado (Inc. IGV):</h3>
                    <p style="font-size: 28px; font-weight: 900; margin: 0;">
                        <span id="costoFinalSpan" style="color: var(--accent);">S/ 0.00</span>
                    </p>
                </div>
            </aside>
        </div>
    </section>
    <footer class="footer">
        <div class="wrap">
            ¬© 2025 RDH ‚Ä¢ Construcci√≥n y Proyectos
        </div>
    </footer>
    <script>
        // === COSTOS BASE INTERNOS (AJUSTADOS AL MERCADO PERUANO 2025) ===
        const BASES_ESPECIALIDAD = {
            civil: { CU_MAT: 1050.00, TARIFA_DIARIA: 4250.00, RENDIMIENTO: 5.00, CU_EQ: 100.00 },
            montaje: { CU_MAT: 1200.00, TARIFA_DIARIA: 6000.00, RENDIMIENTO: 4.50, CU_EQ: 450.00 },
            electrica: { CU_MAT: 1500.00, TARIFA_DIARIA: 6500.00, RENDIMIENTO: 5.00, CU_EQ: 250.00 },
            logistica: { CU_MAT: 200.00, TARIFA_DIARIA: 2500.00, RENDIMIENTO: 8.00, CU_EQ: 50.00 }
        };

        const PORC_DISENO_SUPERVISION = 0.03; 
        const GG_PERCENT = 0.08;      
        const UTILIDAD_PERCENT = 0.10; 
        const IMPUESTO_PERCENT = 0.18; 
        const PORC_HERRAMIENTAS = 0.03; 
                
        // ===============================================
        // üí° BLOQUE DE RESTRICCI√ìN DE ACCESO (Seguridad)
        // ===============================================
        const userToken = localStorage.getItem('userToken');
                
    

        // ‚úÖ FUNCI√ìN PARA RECALCULAR COSTOS EN TIEMPO REAL
        function actualizarCostos() {
            const metrado = parseFloat(document.getElementById('metrado').value);
            
            if (isNaN(metrado) || metrado <= 0) {
                document.getElementById('costoFinalSpan').textContent = 'S/ 0.00';
                return;
            }

        const tipoObra = document.getElementById('tipoObra').value;
        const acabadoFactor = parseFloat(document.getElementById('acabado').value);
        const complejidadDisenoFactor = parseFloat(document.getElementById('complejidadDiseno').value);
        const duracionFactor = parseFloat(document.getElementById('duracion').value); 
        const necesitaEquiposFactor = parseFloat(document.getElementById('necesitaEquipos').value);
        const ubicacionFactor = parseFloat(document.getElementById('ubicacion').value);
        const variacionFactor = parseFloat(document.getElementById('variacion').value) / 100;

            const BASE = BASES_ESPECIALIDAD[tipoObra];
            
            // === C√ÅLCULO T√âCNICO ===
        const rendimientoAJUSTADO = BASE.RENDIMIENTO / duracionFactor; 
        const cuManoObra = BASE.TARIFA_DIARIA / rendimientoAJUSTADO;
        const cuMaterialesAJUSTADO = BASE.CU_MAT * acabadoFactor;
        const cuEquipo = BASE.CU_EQ * necesitaEquiposFactor; 
        const cuHerramientas = cuManoObra * PORC_HERRAMIENTAS;

        // C√°lculo directo del costo de materiales, mano de obra, y equipos
        const cuDirecto = cuMaterialesAJUSTADO + cuManoObra + cuEquipo + cuHerramientas;
        const costoDirectoBase = metrado * cuDirecto;

        // C√°lculo del costo de dise√±o basado en la complejidad de ingenier√≠a
        const costoDiseno = costoDirectoBase * PORC_DISENO_SUPERVISION * complejidadDisenoFactor;

        // Total de costos directos ajustados por la ubicaci√≥n
        const costoDirectoTotal = (costoDirectoBase + costoDiseno) * ubicacionFactor;

        // Gastos generales y utilidad calculados como porcentaje de los costos directos
        const gastosGenerales = costoDirectoTotal * GG_PERCENT;
        const utilidad = costoDirectoTotal * UTILIDAD_PERCENT;
        const subtotal = costoDirectoTotal + gastosGenerales + utilidad;

        // C√°lculo del costo final con impuesto y la variaci√≥n por contingencia
        const costoFinal = subtotal * (1 + IMPUESTO_PERCENT) * (1 + variacionFactor);

        // === MOSTRAR RESULTADOS ===
        const formatter = new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' });
        
        // Mostrar los detalles de los c√°lculos para el usuario
        document.getElementById('cuMaterialSpan').textContent = formatter.format(cuMaterialesAJUSTADO);
        document.getElementById('rendimientoAjustadoSpan').textContent = `${rendimientoAJUSTADO.toFixed(2)} unid/d√≠a`;
        document.getElementById('cuManoObraSpan').textContent = formatter.format(cuManoObra);
        document.getElementById('costoDisenoSpan').textContent = formatter.format(costoDiseno);
        document.getElementById('costoDirectoSpan').textContent = formatter.format(costoDirectoTotal);
        document.getElementById('ggSpan').textContent = formatter.format(gastosGenerales);
        document.getElementById('utilidadSpan').textContent = formatter.format(utilidad);
        document.getElementById('costoFinalSpan').textContent = formatter.format(costoFinal);
    }

        // ‚úÖ AGREGAR LISTENERS A TODOS LOS INPUTS Y SELECTS

    document.getElementById('metrado').addEventListener('change', actualizarCostos);
    document.getElementById('metrado').addEventListener('input', actualizarCostos);
    document.getElementById('tipoObra').addEventListener('change', actualizarCostos);
    document.getElementById('acabado').addEventListener('change', actualizarCostos);
    document.getElementById('complejidadDiseno').addEventListener('change', actualizarCostos);
    document.getElementById('duracion').addEventListener('change', actualizarCostos);
    document.getElementById('necesitaEquipos').addEventListener('change', actualizarCostos);
    document.getElementById('ubicacion').addEventListener('change', actualizarCostos);
    document.getElementById('variacion').addEventListener('input', actualizarCostos);
        // === FUNCI√ìN DE ENV√çO (Al hacer submit) ===
        document.getElementById('cotizacionForm').addEventListener('submit', async function(e) {
            e.preventDefault(); 
            
            document.getElementById('msgForm').hidden = true;
            document.getElementById('msgForm').style.color = '#f59e0b';
            
            const metrado = parseFloat(document.getElementById('metrado').value);
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            if (isNaN(metrado) || metrado <= 0) {
                alert("Por favor, ingresa un valor v√°lido y positivo para el Metrado.");
                return;
            }

          const tipoObra = data.tipoObra;
        const acabadoFactor = parseFloat(data.acabado);
        const complejidadDisenoFactor = parseFloat(data.complejidadDiseno);
        const duracionFactor = parseFloat(data.duracion); 
        const necesitaEquiposFactor = parseFloat(data.necesitaEquipos);
        const ubicacionFactor = parseFloat(data.ubicacion);
        const variacionFactor = parseFloat(data.variacion) / 100;

            const BASE = BASES_ESPECIALIDAD[tipoObra];
            
        const rendimientoAJUSTADO = BASE.RENDIMIENTO / duracionFactor; 
        const cuManoObra = BASE.TARIFA_DIARIA / rendimientoAJUSTADO;
        const cuMaterialesAJUSTADO = BASE.CU_MAT * acabadoFactor;
        const cuEquipo = BASE.CU_EQ * necesitaEquiposFactor; 
        const cuHerramientas = cuManoObra * PORC_HERRAMIENTAS;
        const cuDirecto = cuMaterialesAJUSTADO + cuManoObra + cuEquipo + cuHerramientas;
        const costoDirectoBase = metrado * cuDirecto;
        const costoDiseno = costoDirectoBase * PORC_DISENO_SUPERVISION * complejidadDisenoFactor;
        const costoDirectoTotal = (costoDirectoBase + costoDiseno) * ubicacionFactor;
        const gastosGenerales = costoDirectoTotal * GG_PERCENT;
        const utilidad = costoDirectoTotal * UTILIDAD_PERCENT;
        const subtotal = costoDirectoTotal + gastosGenerales + utilidad;
        const costoFinal = subtotal * (1 + IMPUESTO_PERCENT) * (1 + variacionFactor);

            const parametrosResumen = {
                metrado, tipoObra, acabadoFactor, complejidadDisenoFactor,
                duracionFactor, necesitaEquiposFactor, ubicacionFactor,
                costo_directo_total: costoDirectoTotal.toFixed(2) 
            };

            const datosEnvio = {
                nombre: data.nombre,
                correo: data.correo,
                telefono: data.telefono,
                descripcion: data.descripcion,
                costo_estimado: costoFinal.toFixed(2),
                parametros_resumen: JSON.stringify(parametrosResumen) 
            };

            try {
                const response = await fetch('http://localhost:3001/api/solicitudes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosEnvio)
                });

                const result = await response.json();

                 if (response.ok) {
                document.getElementById('msgForm').textContent = result.mensaje;
                document.getElementById('msgForm').hidden = false;
                document.getElementById('msgForm').style.color = '#22c55e';
                e.target.reset();
                actualizarCostos(); // Reinicia la vista
            } else {
                document.getElementById('msgForm').textContent = 'Error al registrar: ' + result.mensaje;
                document.getElementById('msgForm').hidden = false;
                document.getElementById('msgForm').style.color = '#f87171';
            }
        } catch (error) {
            document.getElementById('msgForm').textContent = 'Error de conexi√≥n. Aseg√∫rese que el Backend (puerto 3001) est√© corriendo.';
            document.getElementById('msgForm').hidden = false;
            document.getElementById('msgForm').style.color = '#f87171';
            console.error('Error de fetch:', error);
            }
        });

        // ‚úÖ CALCULAR COSTO INICIAL AL CARGAR LA P√ÅGINA
        actualizarCostos();
    </script>
</body>
</html>